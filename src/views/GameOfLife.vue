<template>
  <div>
    <!-- title -->
    <div class="flex justify-center mt-5">
      <h1 class="text-xl text-green-600">
        Conway's Game of Life
      </h1>
      <a
        class="ml-2 flex"
        href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life"
        target="_blank"
      >
        <Link class="w-5 h-5 m-auto fill-current text-green-300" />
      </a>
    </div>
    <!-- board -->
    <div class="flex justify-center my-5">
      <table>
        <tr v-for="(row, i) in board" :key="i">
          <td
            class="w-3 h-3 border border-solid border-gray-400 cursor-pointer"
            v-for="(cell, j) in row"
            :key="j"
            @click="toggleCell(i, j)"
            :class="cell === 0 ? '' : 'bg-green-500'"
          ></td>
        </tr>
      </table>
    </div>
    <!-- controls -->
    <div class="flex justify-center">
      <input
        class="w-16 border border-gray-300 rounded mr-1 text-center"
        placeholder="rows"
        v-model.number="rows"
      />
      x
      <input
        class="w-16 border border-gray-400 rounded ml-1 text-center"
        placeholder="columns"
        v-model.number="cols"
      />
      <button
        class="ml-2 bg-transparent hover:bg-green-500 text-green-600 hover:text-white px-2 border border-green-500 hover:border-transparent rounded"
        @click="gameStart()"
        :disabled="startDisabled"
        :class="startDisabled ? 'opacity-50 cursor-not-allowed' : null"
        :title="startDisabled ? 'more than 2500 cells will be lagging' : null"
      >
        {{ startButtonText }}
      </button>
      <button
        class="ml-2 bg-transparent hover:bg-green-500 text-green-600 hover:text-white px-2 border border-green-500 hover:border-transparent rounded"
        @click="gameClear"
      >
        Clear
      </button>
      <button
        class="ml-2 bg-transparent hover:bg-green-500 text-green-600 hover:text-white px-2 border border-green-500 hover:border-transparent rounded"
        @click="randomGame"
      >
        Random
      </button>
    </div>
  </div>
</template>

<script>
import _ from 'lodash'

import Link from '../components/icons/Link.vue'

// GAME RULES
// Any live cell with fewer than two live neighbours dies, as if caused by under-population.
// Any live cell with two or three live neighbours lives on to the next generation.
// Any live cell with more than three live neighbours dies, as if by overcrowding.
// Any dead cell with exactly three live neighbours becomes a live cell, as if by reproduction.
const applyRules = (grid, row, col, rows, cols, clone) => {
  const numNeighbors = countNeighbors(grid, row, col, rows, cols)
  if (grid[row][col] === 1) {
    if (numNeighbors < 2) {
      clone[row][col] = 0
    } else if (numNeighbors === 2 || numNeighbors === 3) {
      clone[row][col] = 1
    } else if (numNeighbors > 3) {
      clone[row][col] = 0
    }
  } else if (grid[row][col] === 0) {
    if (numNeighbors === 3) {
      clone[row][col] = 1
    }
  }
}

const countNeighbors = (grid, row, col, rows, cols) => {
  let count = 0
  if (row - 1 >= 0) {
    if (grid[row - 1][col] === 1) count++
  }
  if (row - 1 >= 0 && col - 1 >= 0) {
    if (grid[row - 1][col - 1] === 1) count++
  }
  if (row - 1 >= 0 && col + 1 < cols) {
    if (grid[row - 1][col + 1] === 1) count++
  }
  if (col - 1 >= 0) {
    if (grid[row][col - 1] === 1) count++
  }
  if (col + 1 < cols) {
    if (grid[row][col + 1] === 1) count++
  }
  if (row + 1 < rows) {
    if (grid[row + 1][col] === 1) count++
  }
  if (row + 1 < rows && col - 1 >= 0) {
    if (grid[row + 1][col - 1] === 1) count++
  }
  if (row + 1 < rows && col + 1 < cols) {
    if (grid[row + 1][col + 1] === 1) count++
  }
  return count
}

export default {
  name: 'GameOfLife',
  components: { Link },
  data() {
    return {
      rows: 50,
      cols: 50,
      started: false,
      paused: false,
      startButtonText: 'Start',
      game: [],
      timer: null,
    }
  },
  computed: {
    board() {
      const board = []
      for (let i = 0; i < this.rows; i++) {
        board[i] = []
        for (let j = 0; j < this.cols; j++) {
          if (this.game[i]) {
            board[i][j] = this.game[i][j] ? 1 : 0
          } else {
            board[i][j] = 0
          }
        }
      }
      return board
    },
    startDisabled() {
      return this.rows * this.cols > 2500
    },
  },
  methods: {
    gameStart() {
      for (let i = 0; i < this.rows; i++) {
        if (!this.game[i]) this.game[i] = []
        for (let j = 0; j < this.cols; j++) {
          this.game[i][j] ? null : this.$set(this.game[i], j, 0)
        }
      }
      if (this.started === false && this.paused === false) {
        this.started = true
        this.startButtonText = 'Pause'
        this.play()
      } else if (this.started === true && this.paused === false) {
        this.paused = true
        this.startButtonText = 'Continue'
        clearInterval(this.timer)
      } else if (this.started === true && this.paused === true) {
        this.paused = false
        this.startButtonText = 'Pause'
        this.play()
      }
    },
    play() {
      const calc = () => {
        const clone = _.cloneDeep(this.game)
        for (let i = 0; i < this.rows; i++) {
          for (let j = 0; j < this.cols; j++) {
            applyRules(this.game, i, j, this.rows, this.cols, clone)
          }
        }
        this.game = clone
      }
      if (this.started) {
        this.timer = setInterval(calc)
      }
    },
    gameClear() {
      this.game = []
      this.started = false
      this.paused = false
      this.startButtonText = 'Start'
      clearInterval(this.timer)
    },
    randomGame() {
      this.gameClear()
      for (let i = 0; i < this.rows; i++) {
        this.$set(this.game, i, [])
        for (let j = 0; j < this.cols; j++) {
          if (Math.random() < 0.1) {
            this.$set(this.game[i], j, 1)
          } else {
            this.$set(this.game[i], j, 0)
          }
        }
      }
    },
    toggleCell(i, j) {
      if (!this.game[i]) {
        this.$set(this.game, i, [])
      }
      if (this.game[i][j] === 1) {
        this.$set(this.game[i], j, 0)
      } else {
        this.$set(this.game[i], j, 1)
      }
    },
  },
}
</script>
